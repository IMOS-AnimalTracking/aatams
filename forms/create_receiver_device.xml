<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="xsltforms/xsltforms.xsl" type="text/xsl"?>
<html xmlns:ows="http://www.opengis.net/ows" xmlns:gml="http://www.opengis.net/gml"
            xmlns="http://www.w3.org/1999/xhtml"
            xmlns:aatams="http://www.imos.org.au/aatams"
            xmlns:xf="http://www.w3.org/2002/xforms"
            xmlns:ev="http://www.w3.org/2001/xml-events"
            xmlns:wfs="http://www.opengis.net/wfs"
            xmlns:ogc="http://www.opengis.net/ogc">
   <head>
      <title>AATAMS Web Interface</title>
      <link href="aatams.css" rel="stylesheet" type="text/css"/>
      <script type="text/javascript" src="aatams_xforms.js" charset="UTF-8"/>
      <xf:model id="model1">
         <xf:instance id="inst_data">
            <wfs:Transaction version="1.1.0" service="WFS">
               <wfs:Insert>
                  <wfs:FeatureCollection>
                     <gml:featureMember>
                        <aatams:device>
                           <aatams:code_name/>
                           <aatams:device_type_ref>
                              <aatams:device_type><aatams:name>RECEIVER</aatams:name></aatams:device_type>
                           </aatams:device_type_ref>
                           <aatams:device_model_ref>
                              <aatams:device_model/>
                           </aatams:device_model_ref>
                           <aatams:serial_number/>
                           <aatams:project_person_ref>
                              <aatams:project_person/>
                           </aatams:project_person_ref>
                        </aatams:device>
                     </gml:featureMember>
                  </wfs:FeatureCollection>
               </wfs:Insert>
            </wfs:Transaction>
         </xf:instance>
         <xf:instance id="inst_subfeatures">
            <data>
               <device_model_id>aatams.device_model.1</device_model_id>
               <!-- device_type_id>aatams.device_type.1</device_type_id-->
               <project_person_id>aatams.project_person.1</project_person_id>
            </data>
         </xf:instance>
         <xf:instance id="inst_device_model"
		 src="../../deegree-wfs/services?service=WFS&amp;version=1.1.0&amp;request=GetFeature&amp;namespace=xmlns(aatams=http://www.imos.org.au/aatams)&amp;typename=aatams:device_model&amp;filter=&lt;ogc:Filter xmlns:ogc='http://www.opengis.net/ogc' xmlns:aatams='http://www.imos.org.au/aatams' xmlns:gml='http://www.opengis.net/gml'&gt;&lt;ogc:PropertyIsEqualTo&gt;&lt;ogc:PropertyName&gt;aatams:device_type_ref/aatams:device_type/aatams:name&lt;/ogc:PropertyName&gt;&lt;ogc:Literal&gt;RECEIVER&lt;/ogc:Literal&gt;&lt;/ogc:PropertyIsEqualTo&gt;&lt;/ogc:Filter&gt;"/>
         <!-- xf:instance id="inst_device_type"
                      src="../../deegree-wfs/services?service=WFS&amp;version=1.1.0&amp;request=GetFeature&amp;namespace=xmlns(aatams=http://www.imos.org.au/aatams)&amp;typename=aatams:device_type"/-->
         <xf:instance id="inst_project_person"
                      src="../../deegree-wfs/services?service=WFS&amp;version=1.1.0&amp;request=GetFeature&amp;namespace=xmlns(aatams=http://www.imos.org.au/aatams)&amp;typename=aatams:project_person">
            <data>
               <aatams:project_person gml:id=""/>
            </data>
         </xf:instance>
         <xf:instance id="inst_project"
                      src="../../deegree-wfs/services?service=WFS&amp;version=1.1.0&amp;request=GetFeature&amp;namespace=xmlns(aatams=http://www.imos.org.au/aatams)&amp;typename=aatams:project"/>
         <xf:instance id="inst_project_id">
            <data>
               <project_id>aatams.project.1</project_id>
            </data>
         </xf:instance>
         <xf:instance id="inst_response">
            <dummy>
               <ows:Exception/>
               <wfs:TransactionResponse>
                  <wfs:InsertResults>
                     <wfs:Feature>
                        <ogc:FeatureId/>
                     </wfs:Feature>
                  </wfs:InsertResults>
               </wfs:TransactionResponse>
            </dummy>
         </xf:instance>
         <xf:bind id="code_name" nodeset="instance('inst_data')//aatams:code_name"
                  type="xsd:string"
                  required="true()"/>
         <!-- xf:bind id="device_type" nodeset="instance('inst_subfeatures')//device_type_id"
                  type="xsd:string"
                  required="true()"/-->
         <xf:bind id="device_model" nodeset="instance('inst_subfeatures')//device_model_id"
                  type="xsd:string"
                  required="false()"/>
         <xf:bind id="serial_number" nodeset="instance('inst_data')//aatams:serial_number"
                  type="xsd:string"
                  required="true()"/>
         <xf:bind id="project_person" nodeset="instance('inst_subfeatures')//project_person_id"
                  type="xsd:string"
                  required="false()"/>
         <xf:bind id="error_message" nodeset="instance('inst_response')//ServiceException"
                  type="xsd:string"/>
         <xf:bind id="success_message" nodeset="instance('inst_response')//ogc:FeatureId/@fid"
                  type="xsd:string"/>
         <xf:submission id="s01" ref="instance('inst_data')" method="post"
                        action="../../deegree-wfs/services"
                        replace="instance"
                        instance="inst_response">
            <xf:action ev:event="xforms-submit">
               <xf:delete nodeset="instance('inst_data')//aatams:status_id[.='']"/>
               <xf:insert nodeset="instance('inst_data')//aatams:device_model_ref/aatams:device_model"
                          origin="instance('inst_device_model')//aatams:device_model[@gml:id=instance('inst_subfeatures')/device_model_id]"/>
               <xf:delete nodeset="instance('inst_data')//aatams:device_model_ref/aatams:device_model"
                          at="1"/>
               <!-- xf:insert nodeset="instance('inst_data')//aatams:device_type_ref/aatams:device_type"
                          origin="instance('inst_device_type')//aatams:device_type[@gml:id=instance('inst_subfeatures')/device_type_id]"/>
               <xf:delete nodeset="instance('inst_data')//aatams:device_type_ref/aatams:device_type"
                          at="1"/-->
               <xf:insert nodeset="instance('inst_data')//aatams:project_person_ref/aatams:project_person"
                          origin="instance('inst_project_person')//aatams:project_person[@gml:id=instance('inst_subfeatures')/project_person_id]"/>
               <xf:delete nodeset="instance('inst_data')//aatams:project_person_ref/aatams:project_person"
                          at="1"/>
            </xf:action>
            <xf:message level="modeless" ev:event="xforms-submit-error">
									Submit error.
								</xf:message>
         </xf:submission>
      </xf:model>
   </head>
   <body><!--Debug--><div class="form">
         <legend>ADD RECEIVER DEVICE</legend>
         <xf:input bind="code_name" incremental="true()">
            <xf:label>Code Name</xf:label>
         </xf:input>
         <!--  xf:select1 bind="device_type" appearance="minimal" incremental="true()">
            <xf:label>Device Type</xf:label>
            <xf:itemset nodeset="instance('inst_device_type')//aatams:device_type">
               <xf:value ref="@gml:id"/>
               <xf:label ref="aatams:name"/>
            </xf:itemset>
         </xf:select1-->
         <xf:select1 bind="device_model" appearance="minimal" incremental="true()">
            <xf:label>Model</xf:label>
            <xf:itemset nodeset="instance('inst_device_model')//aatams:device_model">
               <xf:value ref="@gml:id"/>
               <xf:label ref="aatams:name"/>
            </xf:itemset>
         </xf:select1>
         <xf:input bind="serial_number" incremental="true()">
            <xf:label>Serial Number</xf:label>
         </xf:input>
         <div class="dependant-selects">
            <xf:select1 ref="instance('inst_project_id')/project_id" appearance="minimal"
                        incremental="true()">
               <xf:label>Project</xf:label>
               <xf:itemset nodeset="instance('inst_project')//aatams:project">
                  <xf:value ref="@gml:id"/>
                  <xf:label ref="aatams:name"/>
               </xf:itemset>
               <xf:action ev:event="xforms-value-changed">
                  <xf:setvalue ref="instance('inst_subfeatures')//project_person_id" value=""/>
               </xf:action>
            </xf:select1>
            <xf:select1 bind="project_person" appearance="minimal" incremental="true()">
               <xf:label>Person(Role)</xf:label>
               <xf:itemset nodeset="instance('inst_project_person')//aatams:project_person[aatams:project_fid=instance('inst_project_id')/project_id]">
                  <xf:value ref="@gml:id"/>
                  <xf:label ref="aatams:person_role"/>
               </xf:itemset>
            </xf:select1>
         </div>
         <xf:submit submission="s01">
            <xf:label>Save</xf:label>
         </xf:submit>
         <xf:trigger>
            <xf:label>Reset</xf:label>
            <xf:reset ev:event="DOMActivate"/>
         </xf:trigger>
         <xf:group>
            <xf:output bind="error_message" class="error">
               <xf:label>Error:</xf:label>
            </xf:output>
            <xf:output bind="success_message">
               <xf:label>New Record Id:</xf:label>
            </xf:output>
         </xf:group>
      </div>
      <br/>
      <div id="console"/>
   </body>
</html>
